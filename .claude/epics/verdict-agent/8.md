---
name: Storage Layer
status: open
created: 2025-12-22T03:28:32Z
updated: 2025-12-22T03:32:46Z
github: https://github.com/1psychoQAQ/verdict-agent/issues/8
depends_on: [2]
parallel: true
conflicts_with: []
---

# Task: Storage Layer

## Description

Implement PostgreSQL storage layer for persisting decisions and todos. Use pgx for direct SQL with JSONB support for flexible artifact storage.

## Acceptance Criteria

- [ ] Database connection pooling with pgx
- [ ] CRUD operations for decisions table
- [ ] CRUD operations for todos table
- [ ] Transaction support for atomic writes
- [ ] Migration runner for schema creation
- [ ] Connection health check

## Technical Details

### Repository Interface
```go
type Repository interface {
    // Decisions
    CreateDecision(ctx context.Context, d *Decision) error
    GetDecision(ctx context.Context, id uuid.UUID) (*Decision, error)

    // Todos
    CreateTodo(ctx context.Context, t *Todo) error
    GetTodo(ctx context.Context, id uuid.UUID) (*Todo, error)
    GetTodoByDecisionID(ctx context.Context, decisionID uuid.UUID) (*Todo, error)

    // Health
    Ping(ctx context.Context) error
}

type Decision struct {
    ID        uuid.UUID
    Input     string
    Verdict   json.RawMessage // JSONB
    CreatedAt time.Time
    IsFinal   bool
}

type Todo struct {
    ID         uuid.UUID
    DecisionID uuid.UUID
    Content    string // Markdown content
    CreatedAt  time.Time
}
```

### File Location
```
internal/storage/postgres.go
internal/storage/repository.go
migrations/001_initial.sql
```

### Connection Config
```go
type Config struct {
    DatabaseURL     string
    MaxConns        int32  // default 10
    MinConns        int32  // default 2
    MaxConnLifetime time.Duration
}
```

### Transaction Usage
```go
func (r *Repo) SaveArtifacts(ctx context.Context, d *Decision, t *Todo) error {
    tx, _ := r.pool.Begin(ctx)
    defer tx.Rollback(ctx)

    // Insert decision
    // Insert todo

    return tx.Commit(ctx)
}
```

## Dependencies

- [ ] Task 001 (Project Setup) - database config, schema

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: true (can run alongside pipeline work)

## Definition of Done

- [ ] All CRUD operations work
- [ ] Transactions commit/rollback correctly
- [ ] Connection pooling verified
- [ ] Health check returns correct status
- [ ] Integration tests with test database
