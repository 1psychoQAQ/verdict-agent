---
name: Integration Testing
status: open
created: 2025-12-22T03:28:32Z
updated: 2025-12-22T03:32:46Z
github: https://github.com/1psychoQAQ/verdict-agent/issues/11
depends_on: [9, 10]
parallel: false
conflicts_with: []
---

# Task: Integration Testing

## Description

Implement end-to-end integration tests covering the full pipeline from HTTP request to database storage. Use mock LLM responses for deterministic testing.

## Acceptance Criteria

- [ ] Full pipeline test: POST /api/verdict → database → GET /api/decisions
- [ ] Mock LLM client for deterministic responses
- [ ] Test database setup/teardown
- [ ] Error scenario tests (invalid input, LLM failure, timeout)
- [ ] Concurrent request testing
- [ ] Test coverage > 80% for pipeline package

## Technical Details

### Test Structure
```
tests/
  integration/
    pipeline_test.go     # Full pipeline tests
    api_test.go          # HTTP endpoint tests
    concurrent_test.go   # Load testing
  mocks/
    llm_mock.go          # Mock LLM client
  testdata/
    verdict_response.json
    execution_response.json
```

### Mock LLM Client
```go
type MockLLMClient struct {
    VerdictResponse   string
    ExecutionResponse string
    ShouldFail        bool
    FailAfter         int // Fail after N calls
}

func (m *MockLLMClient) Complete(ctx context.Context, prompt string) (string, error) {
    if m.ShouldFail {
        return "", errors.New("mock error")
    }
    // Return appropriate response based on prompt content
}
```

### Test Database
```go
func setupTestDB(t *testing.T) *pgxpool.Pool {
    // Create test database
    // Run migrations
    // Return connection
    t.Cleanup(func() {
        // Drop test database
    })
}
```

### Test Scenarios
1. **Happy path** - Valid input → verdict → todo → stored
2. **Input validation** - Empty input, too long input
3. **LLM failure** - Mock returns error
4. **Timeout** - Pipeline exceeds timeout
5. **Concurrent requests** - 10 simultaneous requests
6. **Database failure** - Connection error handling

### Coverage Requirements
```bash
go test -cover ./internal/pipeline/...
# Target: > 80%
```

## Dependencies

- [ ] Task 008 (HTTP API) - full API available
- [ ] Task 009 (Frontend) - complete system

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: false (final task)

## Definition of Done

- [ ] All test scenarios pass
- [ ] Coverage > 80% for pipeline package
- [ ] Mock LLM provides deterministic results
- [ ] Tests run in CI (GitHub Actions ready)
- [ ] Test database properly cleaned up
