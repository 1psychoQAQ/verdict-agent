---
name: HTTP API
status: closed
created: 2025-12-22T03:28:32Z
updated: 2025-12-22T04:55:13Z
github: https://github.com/1psychoQAQ/verdict-agent/issues/9
depends_on: [7, 8]
parallel: false
conflicts_with: []
---

# Task: HTTP API

## Description

Implement HTTP API endpoints using chi router. Include rate limiting, CORS, request logging, and proper error responses.

## Acceptance Criteria

- [x] POST /api/verdict - Submit idea, receive verdict + todo
- [x] GET /api/decisions/{id} - Retrieve decision by ID
- [x] GET /api/todos/{id} - Retrieve todo by ID
- [x] GET /health - Health check endpoint
- [x] Rate limiting (10 req/min per IP)
- [x] CORS configured for web frontend
- [x] Structured JSON error responses

## Technical Details

### Route Structure
```go
r := chi.NewRouter()

// Middleware
r.Use(middleware.Logger)
r.Use(middleware.Recoverer)
r.Use(middleware.Timeout(10 * time.Minute))
r.Use(corsMiddleware)
r.Use(rateLimitMiddleware)

// Routes
r.Get("/health", healthHandler)
r.Route("/api", func(r chi.Router) {
    r.Post("/verdict", verdictHandler)
    r.Get("/decisions/{id}", getDecisionHandler)
    r.Get("/todos/{id}", getTodoHandler)
})
```

### Request/Response Types
```go
type VerdictRequest struct {
    Input string `json:"input" validate:"required,max=10000"`
}

type VerdictResponse struct {
    DecisionID string          `json:"decision_id"`
    Decision   json.RawMessage `json:"decision"`
    Todo       string          `json:"todo"` // Markdown
}

type ErrorResponse struct {
    Error   string `json:"error"`
    Code    string `json:"code"`
    Details string `json:"details,omitempty"`
}
```

### File Location
```
internal/api/handlers.go
internal/api/middleware.go
internal/api/routes.go
```

### Error Codes
- `INPUT_TOO_LONG` - Input exceeds 10000 chars
- `VERDICT_FAILED` - Pipeline failed
- `NOT_FOUND` - Decision/todo not found
- `RATE_LIMITED` - Too many requests

## Dependencies

- [ ] Task 006 (Artifact Generator) - generates artifacts
- [ ] Task 007 (Storage Layer) - persists/retrieves data

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: false

## Definition of Done

- [x] All endpoints return correct responses
- [x] Rate limiting blocks excessive requests
- [x] CORS allows frontend origin
- [x] Error responses are consistent JSON
- [x] Integration tests for all endpoints
